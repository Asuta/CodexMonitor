# 浏览器实时观察与远程交互方案（评估稿）

## 1. 背景与目标

你希望把当前桌面端能力扩展到网页端，满足以下目标：

1. 在浏览器里看到当前所有“绘画”（可理解为所有绘画会话/画布/任务状态）。
2. 可以对这些绘画进行互动、交流、沟通（发指令、收反馈、继续操作）。
3. 通过网页从手机/其他电脑访问并控制这台电脑里的应用。
4. 整个过程需要实时状态反馈和实时互动。

---

## 2. 现状（项目当前能力）

基于现有代码结构：

- 桌面端是 Tauri 应用（前端 React + 本机 Rust 后端）。
- 项目已有 `codex_monitor_daemon`，提供 **TCP + 行分隔 JSON-RPC** 的后端通信能力。
- 现有事件流已支持推送（如 `app-server-event`、`terminal-output`、`terminal-exit`）。
- 但目前还没有一个“浏览器可直接访问”的 Web 服务层（HTTP/WebSocket + 认证 + 跨端访问）。

结论：**已有后端基础，但缺少“网页入口层”和“远程访问安全层”。**

---

## 3. 总体方案（建议架构）

建议采用“三层架构”：

1. **本机控制层（Host Agent）**
2. **Web 网关层（Browser Gateway）**
3. **浏览器控制台（Web Console）**

### 3.1 本机控制层（Host Agent）

在当前电脑上常驻一个服务（可复用/封装现有 daemon），职责：

- 连接并管理本机软件（现有 CodexMonitor 后端能力）。
- 维护绘画会话状态（列表、进度、当前活动、输出流）。
- 接收网页控制指令并执行。
- 把执行中的实时事件推送出去。

> 这层可以视为“本机执行引擎”，仍在你的电脑上跑。

### 3.2 Web 网关层（Browser Gateway）

新增一个浏览器友好协议层：

- **HTTP API**：用于登录、查询会话列表、历史消息、控制指令（开始/暂停/继续/停止）。
- **WebSocket**：用于实时事件推送（状态变化、输出增量、错误、完成通知）。
- **认证鉴权**：设备绑定 + token + 权限控制。

这层可以部署为两种模式：

- **模式 A：仅局域网访问（MVP）**：手机/同网段电脑可访问。
- **模式 B：公网远程访问**：通过中继/隧道服务实现“随时随地访问”。

### 3.3 浏览器控制台（Web Console）

一个响应式网页（PC + 手机），功能建议：

- 绘画会话总览（全部会话 + 实时状态 + 最近更新时间）。
- 单会话详情页（消息流、步骤、工具输出、状态时间线）。
- 交互输入（文本/指令/参数），可直接驱动本机执行。
- 实时通知（连接中断、执行完成、异常告警）。

---

## 4. 关键能力设计（对应你的 4 个目标）

### 4.1 “看到当前所有绘画”

最小数据模型建议：

- `DrawingSession`
  - `id`
  - `title`
  - `status`（idle/running/waiting/completed/error）
  - `updatedAt`
  - `preview`（可选缩略图或最近一条摘要）
  - `participants`（可选）

- `DrawingEvent`
  - `sessionId`
  - `type`（status_changed/output_delta/message/tool_event）
  - `payload`
  - `ts`

网页端通过 HTTP 首次拉全量，再通过 WebSocket 持续增量更新。

### 4.2 “互动、交流、沟通”

提供命令接口（HTTP/WS 均可）：

- `send_message(sessionId, text, attachments?)`
- `control_session(sessionId, action)`（暂停/继续/中断）
- `start_session(params)`
- `resume_session(sessionId)`

并支持回执机制：

- 客户端发起 -> 服务端返回 `accepted` -> 实际执行事件流持续回传。

### 4.3 “随时随地打开并控制本机应用”

需要额外引入“远程可达”方案，建议三选一：

1. **Tailscale/WireGuard 私网**（优先推荐，安全/实现快）
2. **Cloudflare Tunnel / FRP / 反向代理**（快速公网访问）
3. **自建中继服务**（可控性最高，开发量最大）

> 如果你们先做评估，建议先从 1 或 2 起步，验证价值后再考虑 3。

### 4.4 “实时反馈 + 实时互动”

建议标准做法：

- 实时协议：WebSocket（必要时补 SSE）。
- 心跳机制：`ping/pong` + 断线重连。
- 状态一致性：序列号/事件游标（cursor）防丢消息。
- 移动端体验：弱网自动重连、增量渲染、消息缓冲。

---

## 5. 安全方案（必须项）

远程控制本机应用属于高风险能力，建议强制纳入：

- **设备绑定**：首次登录通过二维码/一次性口令绑定设备。
- **短期令牌**：Access Token 短时有效 + Refresh Token。
- **TLS 加密**：公网访问必须 HTTPS/WSS。
- **命令授权策略**：高风险操作二次确认（或本机弹窗审批）。
- **审计日志**：记录谁在什么时间执行了什么操作。
- **最小权限**：只暴露必要 API，不直接暴露本机内部端口。

---

## 6. 建议实施路线（分阶段）

### Phase 0：需求澄清（1-2 天）

- 明确“绘画”的业务含义（是会话状态、画布对象，还是整屏远程画面）。
- 明确“控制本机应用”的边界（仅 CodexMonitor，还是系统级应用控制）。

### Phase 1：本机 Web 网关 MVP（约 1-2 周）

- 在本机新增 HTTP + WebSocket 网关。
- 打通会话列表 + 实时状态订阅 + 文本指令发送。
- 仅支持局域网访问。

### Phase 2：远程访问与账号体系（约 1-2 周）

- 增加设备绑定、登录鉴权、HTTPS。
- 引入隧道/私网方案实现跨网络访问。

### Phase 3：移动端体验与稳定性（约 1-2 周）

- 响应式优化、断线重连、离线回放。
- 告警、审计、错误恢复机制完善。

---

## 7. 成功标准（验收口径）

当以下标准满足，可认为方案落地有效：

1. 手机和异地电脑可登录网页并看到全部绘画会话。
2. 任一会话状态变化可在 1 秒内同步到网页。
3. 网页下发指令后，本机执行并实时回传过程输出。
4. 非授权设备无法访问；关键操作可追溯。

---

## 8. 评估时需要先拍板的决策项

1. 你们要的“绘画”是结构化数据（会话/画布对象）还是“远程屏幕画面”？
2. 远程访问优先级：先局域网 MVP，还是直接做公网可达？
3. 安全策略强度：是否必须双因子/二次确认？
4. 首期范围：只控制 CodexMonitor，还是扩展到更多本机应用？

---

## 9. 推荐结论（供评审快速参考）

- 技术上可行，且与当前项目架构兼容。
- 最稳妥路径是：
  - 先做“本机 Web 网关 + 局域网实时控制”（低风险、快验证）
  - 再加“远程访问安全层”（设备绑定 + 加密 + 审计）
- 这样可以最短路径验证你的核心价值：**随时随地看状态 + 实时互动控制。**
